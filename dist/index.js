/* yocto-mongoose - Utility tool to manage mongoose connection and auto loading models. - V2.2.0 */
"use strict";function YMongoose(a){this.logger=a,this.mongoose=mongoose,this.paths={model:"",validator:"",method:"",enums:""},this.crud=!1,this.loaded=!1,this.modules={crud:modCrud(a),validator:modValidator(a),method:modMethod(a),enums:modEnums(a,mongoose.Types),elastic:modElastic(a),redis:modRedis(a)}}var logger=require("yocto-logger"),mongoose=require("mongoose"),_=require("lodash"),path=require("path"),fs=require("fs"),glob=require("glob"),joi=require("joi"),async=require("async"),Schema=mongoose.Schema,Q=require("q"),elastic=require("mongoosastic"),utils=require("yocto-utils"),elasticClient=require("elasticsearch"),modCrud=require("./modules/crud"),modValidator=require("./modules/validator"),modMethod=require("./modules/method"),modEnums=require("./modules/enum"),modElastic=require("./modules/utils/elastic"),modRedis=require("./modules/utils/redis");mongoose.Promise=require("q").Promise,YMongoose.prototype.isConnected=function(){return this.mongoose.connection.readyState===this.mongoose.Connection.STATES.connected},YMongoose.prototype.isDisconnected=function(){return this.mongoose.connection.readyState===this.mongoose.Connection.STATES.disconnected},YMongoose.prototype.connect=function(a,b){var c=Q.defer();return this.logger.info(["[ YMongoose.connect ] -","Try to connect on [",a,"]"].join(" ")),this.mongoose.connection.on("open",function(){this.logger.info(["[ YMongoose.connect ] - Connection succeed on",a].join(" ")),c.resolve()}.bind(this)),this.mongoose.connection.on("error",function(a){this.logger.error(["[ YMongoose.connect ] - Connection failed.","Error is :",a.message].join(" ")),c.reject(a)}.bind(this)),_.each(["connecting","connected","disconnecting","disconnected"],function(a){this.mongoose.connection.on(a,function(){this.logger.debug(["[ YMongoose.connect ] - Mongoose is :",_.capitalize(a)].join(" "))}.bind(this))}.bind(this)),_.isString(a)&&!_.isEmpty(a)?(b=_.isObject(b)&&!_.isEmpty(b)?b:{},_.has(b,"server.sslCA")&&_.isString(b.server.sslCA)&&(b.server.sslCA=[fs.readFileSync(path.normalize(process.cwd()+"/"+b.server.sslCA))]),_.has(b,"server.sslKey")&&_.isString(b.server.sslKey)&&(b.server.sslKey=[fs.readFileSync(path.normalize(process.cwd()+"/"+b.server.sslKey))]),_.has(b,"server.sslCert")&&_.isString(b.server.sslCert)&&(b.server.sslCert=[fs.readFileSync(path.normalize(process.cwd()+"/"+b.server.sslCert))]),this.isDisconnected()&&this.mongoose.connect(a,b)):(this.logger.error("[ YMongoose.connect ] - Invalid url, cannot connect."),c.reject()),c.promise},YMongoose.prototype.disconnect=function(){var a=Q.defer();return this.logger.info("[ YMongoose.disconnect ] - Try to disconnect all connections"),this.isConnected()?this.mongoose.disconnect(function(b){b?(this.logger.error(["[ YMongoose.disconnect ] - Disconnect failed.","Error is :",b.message].join(" ")),a.reject(b)):(this.modules.redis.disconnect(),this.mongoose.connection.close(function(b){b?(this.logger.error(["[ YMongoose.disconnect ] - Connection close failed.","Error is :",b.message].join(" ")),a.reject(b)):(this.logger.info("[ YMongoose.disconnect ] - Closing connection succeed."),a.resolve())}.bind(this)))}.bind(this)):(this.logger.warning("[ YMongoose.disconnect ] - Cannot disconnect orm is not connected."),a.reject()),a.promise},YMongoose.prototype.enableElasticsearch=function(a,b){a=_.isArray(a)?a:[a||{host:"127.0.0.1",port:9200,protocol:"http"}];var c=joi.array().required().items(joi.object().keys({host:joi.string().required().empty().default("127.0.0.1"),port:joi.number().required().default(9200),protocol:joi.string().optional().valid(["http","https"]).default("http"),auth:joi.string().optional().empty()}).default({host:"127.0.0.1",port:9200,protocol:"http"})).default([{host:"127.0.0.1",port:9200,protocol:"http"}]),d=joi.validate(a,c);return d.error?(this.logger.warning(["[ YMongoose.elasticHosts ] - Invalid host config given :",d.error].join(" ")),!1):this.modules.elastic.enableHosts(d.value,b)},YMongoose.prototype.enableRedis=function(a,b,c,d){return this.modules.redis.connect(a,b,d,c)},YMongoose.prototype.getRedis=function(){return this.modules.redis},YMongoose.prototype.models=function(a){return this.logger.debug("[ YMongoose.models ] - Try to set model defintion path."),this.setPath(a,"model")},YMongoose.prototype.validators=function(a){return this.logger.debug("[ YMongoose.validators ] - Try to set validator defintion path."),this.setPath(a,"validator")},YMongoose.prototype.methods=function(a){return this.logger.debug("[ YMongoose.methods ] - Try to set methods defintion path."),this.setPath(a,"method")},YMongoose.prototype.enums=function(a){return this.logger.debug("[ YMongoose.enums ] - Try to set enums defintion path."),this.setPath(a,"enums")},YMongoose.prototype.setPath=function(a,b){var c={model:{ext:"json",name:"model"},validator:{ext:"js",name:"validator"},method:{ext:"js",name:"method"},enums:{ext:"json",name:"enums"}},d=_.find(c,["name",b]);if(!_.isUndefined(d)&&_.isObject(d)&&_.isString(a)&&!_.isEmpty(a)){a=path.isAbsolute(a)?a:path.normalize([process.cwd(),a].join("/"));try{fs.accessSync(a,fs.R_OK);var e=fs.statSync(a);if(!e.isDirectory())throw[a,"is not a valid directory."].join(" ");var f=glob.sync(["**/*.",d.ext].join(""),{cwd:a});0===_.size(f)&&this.logger.warning(["[ YMongoose.setPath ] - Given directory path for",[d.name,"enums"!==d.name?"s":""].join(""),"seems to be empty.","Don't forget to ad your",d.ext,"file before load call"].join(" ")),this.paths[d.name]=a,this.logger.debug(["[ YMongoose.setPath ] -",_.capitalize([d.name,"enums"!==d.name?"s":""].join("")),"path was set to :",this.paths[d.name]].join(" "))}catch(a){return this.logger.error(["[ YMongoose.setPath ] - Set path for",[d.name,"enums"!==d.name?"s":""].join(""),"failed.",a].join(" ")),this.disconnect(),!1}return!0}return this.logger.error(["[ YMongoose.setPath ] - Cannot set directory for [",b,"]","Invalid directory given or cannot retreive types rules"].join(" ")),!1},YMongoose.prototype.isLoaded=function(){return this.loaded},YMongoose.prototype.isReady=function(a){return a&&(this.isConnected()||this.logger.error("[ YMongoose.isReady ] - Connection is not ready."),_.isEmpty(this.paths.model)&&this.logger.error("[ YMongoose.isReady ] - Model definition path is not set."),_.isEmpty(this.paths.validator)&&this.logger.error("[ YMongoose.isReady ] - Validator definition path is not set."),_.isEmpty(this.paths.method)&&this.logger.error("[ YMongoose.isReady ] - Methods definition path is not set."),_.isEmpty(this.paths.enums)&&this.logger.warning("[ YMongoose.isReady ] - Enum definition path is not set.")),this.isConnected()&&!_.isEmpty(this.paths.model)&&!_.isEmpty(this.paths.validator)&&!_.isEmpty(this.paths.method)},YMongoose.prototype.addModel=function(a){var b=Q.defer();if(this.isReady(!0)){_.isObject(a)&&!_.isEmpty(a)&&_.has(a,"model")&&_.has(a.model,"properties")&&_.has(a.model,"name")||(this.logger.error("[ YMongoose.addModel ] - Cannot create model. Invalid data given"),b.reject()),this.logger.debug(["[ YMongoose.addModel ] - Creating model [",a.model.name,"]"].join(" "));var c=!1;if(_.has(a.model,"elastic")&&_.isObject(a.model.elastic)&&this.modules.elastic.configIsReady()&&_.isBoolean(a.model.elastic.enable)&&a.model.elastic.enable){this.logger.debug(["[ YMongoose.addModel ] - Elastic mode is enabled for this model.","Adding default index on all properties to false"].join(" "));var d=this.modules.elastic.addDefaultIndexes(_.cloneDeep(a.model.properties));_.merge(d,a.model.properties),c=!0}var e=new Schema(a.model.properties);if(c){this.logger.debug(["[ YMongoose.addModel ] - Elastic mode is enabled for this model.","Adding mongoosastic plugin to current schema"].join(" "));var f=new elasticClient.Client(_.merge(_.merge({hosts:this.modules.elastic.getHosts()},_.omit(a.model.elastic.options,["hosts","host","port","protocol","auth"])),this.modules.elastic.getOptions()));e.plugin(elastic,{esClient:f})}if(e.elastic=c,_.has(a.model,"crud")&&_.has(a.model.crud,"enable")&&_.isObject(a.model.crud)&&a.model.crud.enable){this.logger.debug(["[ YMongoose.addModel ] - Crud mode is enabled.","Try to add default methods"].join(" "));var g=!1;a.model.crud.redis&&a.model.crud.redis.include&&(g={value:a.model.crud.redis.include,expire:a.model.crud.redis.expire});var h=this.createCrud(e,a.model.crud.exclude,g);h&&(this.logger.debug(["[ YMongoose.addModel ] - Adding Crud method success"].join(" ")),e=h)}if(!_.isUndefined(a.model.validator)&&!_.isNull(a.model.validator)&&_.isString(a.model.validator)&&!_.isEmpty(a.model.validator)){this.logger.debug(["[ YMongoose.addModel ] - A validator is defined.","Try to add a validate method."].join(" "));var i=this.createValidator(e,a.model.validator,a.model.name.toLowerCase());i&&(this.logger.debug(["[ YMongoose.addModel ] - Adding validate method success"].join(" ")),e=i)}if(!_.isUndefined(a.model.fn)&&!_.isNull(a.model.fn)&&_.isArray(a.model.fn)&&!_.isEmpty(a.model.fn)){this.logger.debug(["[ YMongoose.addModel ] - External methods are defined.","Try to add them."].join(" "));var j=this.createMethod(e,a.model.fn,a.model.name.toLowerCase());j&&(this.logger.debug(["[ YMongoose.addModel ] - Adding external methods success"].join(" ")),e=j)}_.isEmpty(this.paths.enums)||(this.modules.enums.load(this.paths.enums)?this.logger.debug("[ YMongoose.addModel ] - loading enums value success"):this.logger.warning("[ YMongoose.addModel ] - loading enums value failed")),e.static("enums",function(){return this.modules.enums}.bind(this));var k=this.mongoose.model(a.model.name,e);c?(this.logger.debug(["[ YMongoose.addModel ] - Elastic mode is enabled for this model.","Create mapping to current model"].join(" ")),k.createMapping(function(a,c){a?this.logger.error(["[ YMongoose.addModel ] - Elastic create mapping error :",a].join(" ")):this.logger.debug(["[ YMongoose.addModel ] - Elastic create mapping success :",utils.obj.inspect(c)].join(" ")),a?b.reject():b.resolve()}.bind(this))):b.resolve()}else b.reject();return b.promise},YMongoose.prototype.createCrud=function(a,b,c){return!!this.isReady(!0)&&(a instanceof Schema?this.modules.crud.add(a,b,c,this.modules.redis):(this.logger.warning([" [ YMongoose.createCrud ] - Cannot process."," given schema is not an instanceof Schema"].join(" ")),!1))},YMongoose.prototype.createValidator=function(a,b,c){return!!this.isReady(!0)&&(a instanceof Schema?this.modules.validator.add(a,this.paths.validator,b,c):(this.logger.warning([" [ YMongoose.createValidator ] - Cannot process."," given schema is not an instanceof Schema"].join(" ")),!1))},YMongoose.prototype.createMethod=function(a,b,c){return!!this.isReady(!0)&&(a instanceof Schema?this.modules.method.add(a,this.paths.method,b,c,this.modules.redis):(this.logger.warning([" [ YMongoose.createMethod ] - Cannot process."," given schema is not an instanceof Schema"].join(" ")),!1))},YMongoose.prototype.load=function(){var a=Q.defer(),b=[],c={total:0,processed:0},d=glob.sync("**/*.json",{cwd:this.paths.model,realpath:!0}),e=joi.object().keys({model:joi.object().keys({name:joi.string().required(),properties:joi.object().required(),crud:joi.object().required().keys({enable:joi.boolean().required(),exclude:joi.array().required().empty(),redis:joi.object().optional().keys({enable:joi.boolean().required().default(!1),expire:joi.number().optional().min(0).default(0),include:joi.array().items(joi.string().empty().valid(["get","getOne"]))})}).allow("enable","exclude"),validator:joi.string().optional()}).unknown()}).unknown(),f=async.queue(function(a,b){var d=joi.validate(a.data,e);if(this.logger.debug(["----------------------------","Processing :Â [",a.file,"]","----------------------------"].join(" ")),!_.isNull(d.error)){var f=["Invalid schema for [",a.file,"] Error is :",d.error].join(" ");return this.logger.error(["[ YMongoose.load.queue ] -",f].join(" ")),b(f)}this.addModel(a.data).then(function(){c.processed++,b()}).catch(function(){b(["Cannot create model for  [",a.file,"]"].join(" "))})}.bind(this),100);f.drain=function(){this.logger.debug([_.repeat("-",28),"[ Process Queue Complete ]",_.repeat("-",28)].join(" ")),this.logger.info("[ YMongoose.load ] - All Model was processed & loaded."),this.loaded=c.processed===c.total,this.loaded?a.resolve():(this.logger.error(["[ YMongoose.load ] -","All item was NOT correctly processed.","Check your logs."].join(" ")),a.reject(),this.disconnect())}.bind(this);var g=[];return async.each(d,function(b,d){var e=b.replace(path.dirname(b),"");try{var f=JSON.parse(fs.readFileSync(b,"utf-8"));g.push({file:e,data:f}),c.total++,d()}catch(b){var h=["Cannot add item to queue. Error is : [",b,"] for [",e,"]"].join(" ");this.logger.error(["[ YMongoose.load ] -",h].join(" ")),a.reject(h),this.disconnect()}}.bind(this),function(){f.push(g,function(a){a&&(this.logger.error(["[ YMongoose.load ] - Cannot add an item to queue [",a,"]"].join(" ")),b.push(a))}.bind(this))}.bind(this)),a.promise},YMongoose.prototype.getModel=function(a,b){if(this.isReady(!0)&&this.isLoaded()&&_.isString(a)&&!_.isEmpty(a))try{var c=this.mongoose.model(a);return c.Types=mongoose.Types,_.isBoolean(b)&&b?new c:c}catch(a){return this.logger.error("[ YMongoose.getModel ] - Model not found. Invalid schema name given."),this.logger.debug(["[ YMongoose.getModel ] -",a].join(" ")),!1}return this.logger.error("[ YMongoose.getModel ] - Cannot get model. Invalid schema name given."),!1},module.exports=function(a){return(_.isUndefined(a)||_.isNull(a))&&(logger.warning("[ YMongoose.constructor ] - Invalid logger given. Use internal logger"),a=logger),new YMongoose(a)};